<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <title>Safe Targeted Simulator</title>
  <style>
    body{font-family:Arial;margin:20px;background:#f7fafc}
    .card{max-width:900px;margin:auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    button{padding:8px 12px;border:none;border-radius:6px;background:#2563eb;color:#fff;cursor:pointer}
    button.sec{background:#6b7280}
    #log{background:#0b1220;color:#d1fae5;padding:10px;height:160px;overflow:auto;border-radius:8px;font-family:monospace}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="card">
    <h2>Safe Targeted Simulator — Local Demo</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px">
      <label>Site Label <input id="site" value="college-demo.local"></label>
      <label>Duration (min) <input id="duration" type="number" value="5" min="1"></label>
      <label>Target total views <input id="target" type="number" value="900" min="1"></label>
      <label>Mode
        <select id="mode">
          <option value="demo">Demo (1s = 1min)</option>
          <option value="real">Real-time (60s = 1min)</option>
        </select>
      </label>
    </div>
    <div style="margin-bottom:10px">
      <button id="start">Start</button>
      <button id="stop" class="sec">Stop</button>
      <button id="export" class="sec">Export CSV</button>
      <button id="preset" class="sec">Pre-generate & Show Now</button>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px">
        <canvas id="chart"></canvas>
      </div>
      <div style="width:340px">
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const durationEl = document.getElementById('duration');
    const targetEl = document.getElementById('target');
    const siteEl = document.getElementById('site');
    const modeEl = document.getElementById('mode');

    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    // Chart
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type:'bar',
      data:{ labels:[], datasets:[{label:'Views per minute', data:[], backgroundColor:'#2563eb'}]},
      options:{responsive:true, scales:{y:{beginAtZero:true}}}
    });

    let state = { running:false, minute:0, timer:null, data:[] };

    // Distribute 'total' into 'n' minutes with randomness and occasional spikes
    function distribute(total, n){
      // base average
      const avg = total / n;
      const arr = [];
      let remaining = total;
      for(let i=0;i<n;i++){
        // give a random around avg: ±20%, plus occasional spike up to 2x avg with low prob
        const spike = (Math.random() < 0.08) ? Math.round(Math.random()*avg*1.5) : 0;
        const noise = Math.round((Math.random()-0.5) * avg * 0.4);
        let val = Math.max(0, Math.round(avg + noise + spike));
        // ensure we don't exceed remaining badly
        if(i === n-1) val = remaining; // last minute gets whatever's left
        arr.push(val);
        remaining -= val;
      }
      // If rounding made remaining != 0, adjust
      let idx = 0;
      while(remaining !== 0){
        if(remaining > 0){ arr[idx % n]++; remaining--; }
        else { if(arr[idx % n] > 0){ arr[idx % n]--; remaining++; } }
        idx++;
      }
      return arr;
    }

    function renderFromArray(arr){
      state.data = arr.map((v,i)=>({minute:i+1, views:v, site: siteEl.value}));
      updateChartAndLog();
    }

    function updateChartAndLog(){
      chart.data.labels = state.data.map(r=>r.minute);
      chart.data.datasets[0].data = state.data.map(r=>r.views);
      chart.update();
      log(`Rendered ${state.data.length} minutes, total views=${state.data.reduce((s,r)=>s+r.views,0)}`);
    }

    function startSimulation(){
      if(state.running) return;
      const duration = parseInt(durationEl.value,10) || 1;
      const target = parseInt(targetEl.value,10) || 1;
      const mode = modeEl.value;
      const interval = (mode==='real') ? 60000 : 1000;

      // create distribution
      const perMinute = distribute(target, duration);
      state.running = true;
      state.minute = 0;
      state.data = [];
      log('Simulation started (local-only). Mode='+mode);

      state.timer = setInterval(()=>{
        state.minute++;
        const views = perMinute[state.minute-1] || 0;
        state.data.push({minute: state.minute, views, site: siteEl.value});
        // update chart dynamically
        chart.data.labels.push(state.minute);
        chart.data.datasets[0].data.push(views);
        chart.update();
        log(`Minute ${state.minute}: ${views} views`);
        if(state.minute >= duration){
          clearInterval(state.timer);
          state.running = false;
          log('Simulation finished.');
        }
      }, interval);
    }

    function stop(){
      if(state.timer) clearInterval(state.timer);
      state.running = false;
      log('Stopped.');
    }

    function exportCSV(){
      if(state.data.length===0){ alert('No data'); return; }
      let csv = 'minute,views,site\n';
      state.data.forEach(r=> csv += `${r.minute},${r.views},"${r.site}"\n`);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='sim.csv'; a.click(); URL.revokeObjectURL(url);
    }

    document.getElementById('start').onclick = startSimulation;
    document.getElementById('stop').onclick = stop;
    document.getElementById('export').onclick = exportCSV;
    document.getElementById('preset').onclick = ()=>{
      const duration = parseInt(durationEl.value,10) || 1;
      const target = parseInt(targetEl.value,10) || 1;
      renderFromArray(distribute(target, duration));
      log('Pre-generated data shown (instant). Use Start for timed demo.');
    };

    // preload demo
    document.getElementById('preset').click();
  </script>
</body>
</html>

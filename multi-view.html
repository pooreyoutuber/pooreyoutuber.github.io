<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Website Booster Prime (Node.js/Render) - Client Fix</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* --- CSS Styles --- */
  :root{
    --bg: #f6f8fb;--card: #ffffff;--muted: #6b7280; 
    --accent: #0f4f7f;--success: #059669; --border: #e5e7eb;
    --shadow: 0 8px 20px rgba(0,0,0,0.08);--radius: 12px;--gap: 16px; 
    --primary-blue: #0ea5e9;--danger: #dc2626;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: 'Inter', system-ui; background: var(--bg); color: #111827; line-height: 1.5; }
  .wrap { max-width: 1400px; margin: 24px auto; padding: 12px; } 
  header { margin-bottom: 20px; text-align: center; }
  h1 { font-size: 2.2rem; color: var(--accent); margin-bottom: 5px; }
  h4 { margin: 0 0 8px 0; font-size: 1.1rem; }
  p { margin: 0; font-size: 0.9rem; color: var(--muted); }
  
  .controls, .slots-grid { 
    background: var(--card); border: 1px solid var(--border); 
    border-radius: var(--radius); padding: var(--gap); margin-bottom: var(--gap); 
    box-shadow: var(--shadow);
  }
  
  /* Input Styling */
  input[type="text"], input[type="number"], select {
    width: 100%; padding: 10px 12px; border: 1px solid var(--border); 
    border-radius: 8px; font-size: 1rem; margin-bottom: 10px; 
    transition: border-color 0.2s;
  }
  input[type="text"]:focus, input[type="number"]:focus, select:focus {
    border-color: var(--primary-blue); outline: none;
  }
  
  /* Buttons */
  button {
    padding: 10px 15px; border: none; border-radius: 8px; font-weight: 600; 
    cursor: pointer; transition: background-color 0.2s; font-size: 0.95rem;
  }
  .run-all-btn { background: var(--primary-blue); color: white; }
  .run-all-btn:hover { background: #0c88c0; }
  .stop-btn { background: var(--danger); color: white; display: none; }
  .stop-btn:hover { background: #b01b1b; }
  .run-btn { background: var(--success); color: white; margin-top: 8px; width: 100%; }
  .run-btn:hover { background: #047857; }
  
  /* Layouts */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
  .field-row { display: flex; gap: 8px; margin-bottom: 10px; }
  .field-row > input, .field-row > select { margin-bottom: 0; }
  .checkbox-row { display: flex; align-items: center; margin-bottom: 10px; gap: 15px; }
  .checkbox-row input[type="checkbox"] { width: auto; margin-right: 5px; }
  .checkbox-row label { color: #333; font-size: 0.9rem; cursor: pointer; }

  /* Slots Grid */
  .slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--gap); }
  .slot { border: 1px solid var(--border); padding: 12px; border-radius: 8px; background: #fff; }
  .slot.running { border-color: var(--primary-blue); background: #e0f2fe; }
  .slot.running .status-text { color: var(--primary-blue); font-weight: 600; }
  .status-text { min-height: 20px; }
  
  /* Media Queries */
  @media (max-width: 768px) {
    .grid-2 { grid-template-columns: 1fr; }
    .slots-grid { grid-template-columns: 1fr; }
    .wrap { margin: 10px auto; padding: 10px; }
  }
</style>

</head>
<body>
<div class="wrap">
  <header>
    <h1>üöÄ Website Booster PRIME</h1>
    <p>Ad Earning Stabilization & High-Quality Traffic Tool</p>
  </header>

  <div class="controls">
    <h3>üåê Global Settings (Tool 4: Website Booster Prime)</h3>
    
    <div class="grid-2">
      <input type="text" placeholder="Target URL (e.g., https://my-site.github.io/)" id="globalUrl" value="https://example.com" required>
      <div class="field-row">
        <input type="number" placeholder="Sessions (Slots)" id="numSlots" value="5" min="1" max="50">
        <input type="number" placeholder="Session Duration (seconds)" id="sessionDuration" value="60" min="30" max="120">
      </div>
    </div>
    
    <div class="grid-2" style="margin-bottom: 0;">
        <input type="text" placeholder="GA ID (G-XXXXXXXXXX)" id="gaIdInput" value="">
        <input type="text" placeholder="GA API Secret" id="apiSecretInput" value="">
    </div>

    <p style="margin: 5px 0 15px 0; font-size: 0.85rem;">GA keys are optional. Use them to verify traffic in GA4 DebugView.</p>

    <div class="checkbox-row">
        <input type="checkbox" id="smartClicker">
        <label for="smartClicker">Enable Smart Clicker Mode (Internal Click)</label>
        
        <input type="checkbox" id="activeUserMode" checked>
        <label for="activeUserMode" style="color: var(--success); font-weight: bold;">Enable Active User Mode (Scroll/Engage Fix)</label>
    </div>
    
    <div class="field-row" style="align-items: center;">
        <label for="referrerSelect" style="white-space: nowrap; margin-right: 5px;">Referrer Source:</label>
        <select id="referrerSelect" style="flex-grow: 1;">
            </select>
        <button onclick="selectRandomReferrer()">Randomize</button>
    </div>
    
    <div class="field-row" style="margin-bottom: 0;">
        <button id="runAllBtn" class="run-all-btn" style="flex-grow: 1;">Load & Run All Slots</button>
        <button id="globalStopBtn" class="stop-btn" style="flex-grow: 1;">STOP ALL</button>
        <input type="checkbox" id="repeatModeCheckbox" style="width: auto;">
        <label for="repeatModeCheckbox" style="white-space: nowrap; color: var(--accent);">Repeat Mode (5 Mins)</label>
    </div>
    
  </div>

  <div id="slotsContainer" class="slots-grid">
    </div>

</div>

<script>
// --- GLOBAL VARIABLES ---
let currentSlots = [];
const slotTimeouts = []; // Array to store all timeouts for cleanup
const numSlotsInput = document.getElementById('numSlots');
const globalStopBtn = document.getElementById('globalStopBtn');
const repeatModeCheckbox = document.getElementById('repeatModeCheckbox');
const globalUrlInput = document.getElementById('globalUrl');
const globalDurationInput = document.getElementById('sessionDuration');
const smartClickerCheckbox = document.getElementById('smartClicker');
// NEW: Active User Mode Checkbox (for Scroll Simulation)
const activeUserModeCheckbox = document.getElementById('activeUserMode'); 

// IMPORTANT: Replace this with your actual Render/Server URL
const API_BASE_URL = 'https://pooreyoutuber-api.onrender.com'; 

// --- UTILITIES ---
const getRandomDelay = () => Math.floor(Math.random() * 5000) + 1000; // 1 to 6 seconds random delay
const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// Array of traffic sources to simulate realistic referral traffic
const randomReferrers = [
    "https://www.google.com/search?q=college+project+tool",
    "https://www.facebook.com/posts/12345",
    "https://www.youtube.com/watch?v=tool-demo",
    "https://www.bing.com/search?q=best+github+tool",
    "https://www.reddit.com/r/webdev/comments/tool",
    "https://t.co/random-tweet-link", // X/Twitter
    "" // Direct Traffic (use sparingly)
];

// --- SLOT CLASS ---
class Slot {
    constructor(index) {
        this.index = index;
        this.element = document.createElement('div');
        this.element.className = 'slot';
        this.render();
    }

    render() {
        // [Existing HTML Structure]
        this.element.innerHTML = `
            <h4>Slot #${this.index + 1}</h4>
            <div class="field-row">
                <input type="text" placeholder="Proxy IP:Port" id="ipPort${this.index}" value="">
                <input type="text" placeholder="Auth (user:pass)" id="auth${this.index}" value="">
            </div>
            <div class="field-row">
                <select id="country${this.index}">
                    <option value="">Random Country</option>
                    <option value="US">USA</option>
                    <option value="IN">India</option>
                    <option value="JP">Japan</option>
                    <option value="DE">Germany</option>
                </select>
                <input type="text" placeholder="Custom Client ID (optional)" id="cid${this.index}" value="">
            </div>
            <p id="status${this.index}" class="status-text">Ready. (0 events sent)</p>
            <div class="slot-controls">
                <button class="run-btn" data-index="${this.index}">Run Slot</button>
            </div>
        `;
    }

    setStatus(message, isRunning = false) {
        const statusElement = document.getElementById(`status${this.index}`);
        statusElement.textContent = message;
        this.element.classList.toggle('running', isRunning);
    }

    getProxyDetails() {
        const [ip, port] = document.getElementById(`ipPort${this.index}`).value.split(':');
        const auth = document.getElementById(`auth${this.index}`).value;
        const cid = document.getElementById(`cid${this.index}`).value || this.generateDefaultCid();
        return { ip, port, auth, cid };
    }
    
    // New function to generate a unique Client ID if none is provided
    generateDefaultCid() {
        return 'cid-' + Math.random().toString(36).substring(2, 10);
    }
}

// --- CORE FUNCTIONALITY ---
function renderSlots(count) {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';
    currentSlots = [];
    for (let i = 0; i < count; i++) {
        const slot = new Slot(i);
        currentSlots.push(slot);
        container.appendChild(slot.element);
    }
}

async function runSlot(slotIndex) {
    const s = currentSlots[slotIndex];
    const { ip, port, auth, cid } = s.getProxyDetails();

    const targetUrl = globalUrlInput.value;
    const duration = globalDurationInput.value;
    const smartClicker = smartClickerCheckbox.checked ? 1 : 0;
    
    // üöÄ NEW LOGIC: Active User Mode (Sends the High-Quality flag)
    const activeUser = activeUserModeCheckbox.checked ? 1 : 0; 
    
    // Traffic Source Logic
    const referrer = document.getElementById('referrerSelect').value;
    
    if (!ip || !port || !targetUrl) {
        s.setStatus('Error: IP:Port and Target URL are required.');
        return;
    }

    try {
        const gaId = document.getElementById('gaIdInput').value;
        const apiSecret = document.getElementById('apiSecretInput').value;
        
        // Show status before the request is made
        s.setStatus('Sending Request...', true);

        // Build the query parameters for the API call
        const params = new URLSearchParams({
            target: targetUrl,
            ip: ip,
            port: port,
            auth: auth,
            uid: cid,
            ga_id: gaId,
            api_secret: apiSecret,
            sessionDuration: duration,
            referrer: referrer,
            clicker: smartClicker,
            // üöÄ NEW PARAMETER: activeUser for scroll/engagement simulation
            activeUser: activeUser 
        });

        // The API call to your fixed backend endpoint
        const response = await fetch(`${API_BASE_URL}/proxy-request?${params.toString()}`);
        const data = await response.json();

        if (response.ok && data.status === 'ACCEPTED') {
            // Success response means the background job started
            s.setStatus(`Accepted ‚úÖ. Session Duration: ${duration}s. (Check console for progress)`, true);
        } else {
            // Handle server-side errors
            s.setStatus(`FAILED ‚ùå: ${data.error || 'Server rejected the request.'}`, false);
        }

    } catch (error) {
        console.error(`Slot ${s.index + 1} CRITICAL Error:`, error);
        s.setStatus(`CRITICAL FAIL üõë: Connection Error to API Server.`, false);
    }
}

function stopAllAutomation() {
    // Clear all scheduled timeouts
    slotTimeouts.forEach(clearTimeout);
    slotTimeouts.length = 0; // Clear the array
    
    // Update UI state
    currentSlots.forEach(s => {
        s.setStatus('Stopped manually.');
    });
    
    globalStopBtn.style.display = 'none';
    document.getElementById('runAllBtn').style.display = 'inline-block';
    
    // Reset repeat mode UI
    repeatModeCheckbox.checked = false;
    repeatModeCheckbox.disabled = false;
}

function selectRandomReferrer() {
    const referrerSelect = document.getElementById('referrerSelect');
    referrerSelect.value = randomReferrers[randomInt(0, randomReferrers.length - 1)];
}

// Fills the referrer dropdown options
function populateReferrers() {
    const referrerSelect = document.getElementById('referrerSelect');
    referrerSelect.innerHTML = '';
    randomReferrers.forEach(ref => {
        const option = document.createElement('option');
        option.value = ref;
        option.textContent = ref || "Direct / None";
        referrerSelect.appendChild(option);
    });
}


// --- EVENT LISTENERS (Delegation for Run Buttons) ---
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('run-btn')) {
        const slotIndex = parseInt(e.target.dataset.index);
        runSlot(slotIndex);
    }
});

// Run All Button Logic
document.getElementById('runAllBtn').addEventListener('click', () => {
    if (repeatModeCheckbox.checked) {
        // --- REPEAT MODE LOGIC ---
        
        // Check if all slots have IP:Port for repeat mode
        const allSlotsHaveProxy = currentSlots.every(s => {
            const { ip, port } = s.getProxyDetails();
            return ip && port;
        });

        if (!allSlotsHaveProxy) {
            alert("Error: All slots must have a valid IP:Port for Repeat Mode.");
            return;
        }
        
        // UI State change for Repeat Mode
        document.getElementById('runAllBtn').style.display = 'none';
        globalStopBtn.style.display = 'inline-block';
        repeatModeCheckbox.disabled = true;

        const scheduleNextRun = () => {
            if (repeatModeCheckbox.checked) {
                // 1. Run all slots
                currentSlots.forEach((s, index) => runSlot(index));
                
                // 2. Schedule the next run (5 minutes + random jitter, matching your VPN change)
                const nextDelay = 300000 + randomInt(10000, 30000); // 5 minutes 10 seconds to 5 minutes 30 seconds
                const nextDelayInSeconds = (nextDelay / 1000).toFixed(1);
                
                // Set the timeout and track it
                const timeoutId = setTimeout(scheduleNextRun, nextDelay);
                // Clear previous timeout and store new one (Only one active scheduled timeout for next cycle)
                slotTimeouts.forEach(clearTimeout);
                slotTimeouts.length = 0; 
                slotTimeouts.push(timeoutId); 
                
                currentSlots.forEach(s => s.setStatus(`Repeat Running. Next cycle in ${nextDelayInSeconds}s...`, true));
                
                // **VPN CHANGE ALERT**
                alert(`ATTENTION: VPN/Proxy ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! (Next run in ${nextDelayInSeconds}s)`);

            }
        };
        
        // Start the first scheduled run after a brief delay
        const initialDelay = getRandomDelay();
        const initialTimeoutId = setTimeout(scheduleNextRun, initialDelay);
        slotTimeouts.push(initialTimeoutId);
        
        const initialDelayInSeconds = (initialDelay / 1000).toFixed(1);
        currentSlots.forEach(s => s.setStatus(`Starting Repeat Mode (First cycle in ${initialDelayInSeconds}s)...`, true));
        
    } else {
        // Simple Run All (Non-Repeat Mode)
        currentSlots.forEach((s, index) => runSlot(index));
    }
});


// Event listeners
numSlotsInput.addEventListener('change', (e) => {
    let count = parseInt(e.target.value);
    if (isNaN(count)) count = 1; 
    renderSlots(count);
});

// **REMOVED** autoScrollModeCheckbox LISTENER (functionality now managed by activeUserModeCheckbox + Backend)

globalStopBtn.addEventListener('click', stopAllAutomation);

repeatModeCheckbox.addEventListener('change', () => {
    // Stop automation if repeat mode is unchecked while running
    if (!repeatModeCheckbox.checked && globalStopBtn.style.display === 'block') {
        stopAllAutomation();
    }
});


// Initial setup when the page loads
populateReferrers();
selectRandomReferrer();
renderSlots(parseInt(numSlotsInput.value));
</script>
</body>
</html>

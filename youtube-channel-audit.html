<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Channel SEO & Audit Tool — Secure</title>
  <style>
    :root{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f7fafc;color:#111}
    body{margin:16px}
    /* Main Card Styling */
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.06);max-width:1100px; margin: 0 auto;}
    /* Input/Button Styling */
    label{display:block;margin:8px 0}
    input,select,button,textarea{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px}
    button{cursor:pointer; background:#007bff; color:#fff; }
    button:hover { background:#0056b3; }
    /* Data Display Styling */
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .muted{color:#666;font-size:13px}
    .small{font-size:13px}
    .bad{color:#b91c1c}
    .good{color:#065f46}
    .kpi{display:inline-block;padding:6px 10px;border-radius:8px;margin-right:8px;background:#f1f5f9; font-weight: bold;}
    
    /* Audit Summary Grid (to mimic your screenshot's layout) */
    .audit-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;}
    .audit-item { padding: 10px; border: 1px solid #eee; border-radius: 6px; }
    .status-icon { font-size: 20px; float: right; }
    .check { color: #065f46; }
    .cross { color: #b91c1c; }
    
    /* Overall Score Circle */
    .score-circle { width: 150px; height: 150px; border-radius: 50%; border: 10px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; position: relative;}
    .score-container { text-align: center; margin: 20px auto; width: 300px;}
    
  </style>
</head>
<body>
  <h1>YouTube Channel SEO & Audit Tool</h1>
  <div class="card">
    
    <p class="muted">Enter a YouTube <strong>channel name</strong> or <strong>channel ID</strong>. This tool uses a **secure server-side proxy** (via your Replit deployment) to keep the API key hidden and safe.</p>

<label>Channel name or channel ID: <input id="query" placeholder="e.g. PewDiePie or UC-lHJZR3Gqxm24_Vd_AJ5Yw" style="width:100%" /></label>

<div style="margin-top:10px; display: flex; justify-content: flex-start; gap: 10px;">
  <button id="searchBtn">Search & Audit</button>
  <button id="downloadCsv" disabled style="background:#17a2b8;">Download CSV (videos)</button>
</div>

<div id="status" class="muted" style="margin-top:10px">Ready.</div>

<hr />

<div id="fullReport">
    <div class="score-container">
        <div id="scoreCircle" class="score-circle">50%</div>
        <div id="scoreMessage" style="margin-top: 10px; font-weight: bold;">Your page could be better</div>
        <div id="recommendations" style="margin-top: 5px; color: #dc3545;">You have 5 Recommendations</div>
        <div class="muted small">Report Generated: <span id="reportDate"></span></div>
    </div>
    
    <h2>Profile</h2>
    <div class="audit-grid" id="profileAudit"></div>

    <h2>Content</h2>
    <div class="audit-grid" id="contentAudit"></div>

    <h2>Engagement</h2>
    <div class="audit-grid" id="engagementAudit"></div>

    <hr/>
    <h3>Top videos (by views)</h3>
    <div id="topVideos"></div>

    <h3>Video list</h3>
    <div id="videoTable"></div>
    
    <h3>Audit / Suggestions</h3>
    <div id="audit"></div>
</div>
  </div><script>

const searchBtn = document.getElementById('searchBtn');
const queryEl = document.getElementById('query');
const statusEl = document.getElementById('status');
const topVideosEl = document.getElementById('topVideos');
const videoTableEl = document.getElementById('videoTable');
const auditEl = document.getElementById('audit');
const downloadCsvBtn = document.getElementById('downloadCsv');

// *******************************************************************
// ** FINAL CORRECTED SECURE REPLIT URL (Based on Replit Assistant's fix) **
// *******************************************************************
const API_BASE_URL = "https://3ba947fe-ebdb-424b-8fa6-20b5a674d382-00-3knb1boao5qhl.pike.replit.dev";


function log(s){ statusEl.textContent = s; }

function createAuditItem(title, value, status, detail) {
    const icon = status === 'good' ? '&#10004;' : '&#10006;'; // Checkmark or Cross
    const colorClass = status === 'good' ? 'good' : 'bad';
    return `
        <div class="audit-item">
            <strong>${title}</strong>
            <span class="status-icon ${colorClass}">${icon}</span>
            <div class="small" style="margin-top: 5px;">${value}</div>
            <div class="muted small">${detail}</div>
        </div>
    `;
}

function renderAuditGrid(channel, videos, analysis) {
    const stats = channel.statistics || {};
    const snippet = channel.snippet || {};

    const profileHTML = [
        createAuditItem("Channel Title", snippet.title || "Missing", snippet.title ? 'good' : 'bad', "Your page has description title."),
        createAuditItem("Description Text", snippet.description ? 'Your page has description.' : "No description", snippet.description ? 'good' : 'bad', "A compelling description helps SEO."),
        createAuditItem("Channel Country", snippet.country || "No country", snippet.country ? 'good' : 'bad', "Setting a country helps with regional targeting."),
        // Add more profile checks if needed
    ].join('');
    document.getElementById('profileAudit').innerHTML = profileHTML;

    const contentHTML = [
        createAuditItem("Number of Videos", `Videos: ${analysis.totals.videos}`, analysis.totals.videos > 50 ? 'good' : 'bad', `Your page has good number of videos. ${analysis.totals.videos}`),
        createAuditItem("Posting Frequency", `Low frequency: 0.1 videos a day`, analysis.avgUploadGap < 30 ? 'good' : 'bad', `For performance reasons, this assessment was only performed on your 50 most recent posts.`), // Placeholder data for frequency
        createAuditItem("Video Completeness", `Has one or more uncompleted videos`, analysis.missingTagsCount === 0 ? 'good' : 'bad', `For performance reasons, this assessment was only performed on your 50 most recent posts. <span style="cursor:pointer; color: blue;" onclick="document.getElementById('audit').scrollIntoView();">Show details</span>`),
        // Add more content checks if needed
    ].join('');
    document.getElementById('contentAudit').innerHTML = contentHTML;
    
    // Engagement is simplified for this demo, usually requires more complex calculation
    const engagementHTML = [
        createAuditItem("Channel Subscribers", `${stats.subscriberCount||'295'}`, (stats.subscriberCount||0) > 100 ? 'good' : 'bad', "Your page has good number of followers."),
        createAuditItem("Average Video Views", `${analysis.avgViews.toFixed(0)}`, analysis.avgViews > 200 ? 'good' : 'bad', "Your page has good videos views."),
        createAuditItem("Average Video Likes", `${analysis.avgLikes.toFixed(0)}`, analysis.avgLikes > 10 ? 'good' : 'bad', "Low videos likes."),
        createAuditItem("Average Video Comments", `${analysis.avgComments.toFixed(0)}`, analysis.avgComments > 0 ? 'good' : 'bad', "Low videos comments."),
    ].join('');
    document.getElementById('engagementAudit').innerHTML = engagementHTML;

    // Render Score
    const score = 100 - (analysis.issues.length * 10); // Simple scoring based on issues
    document.getElementById('scoreCircle').textContent = `${Math.max(50, score)}%`;
    document.getElementById('recommendations').textContent = `You have ${analysis.issues.length} Recommendations`;
    document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', {day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'});
}

function analyzeVideos(channel, videos){
  const totals = { videos: videos.length, views:0, likes:0, comments: 0 };
  let top = null;
  videos.forEach(v=>{
    const s = v.statistics || {};
    const viewCount = Number(s.viewCount || 0);
    const likeCount = Number(s.likeCount || 0);
    const commentCount = Number(s.commentCount || 0);
    
    totals.views += viewCount;
    totals.likes += likeCount;
    totals.comments += commentCount;
    
    if(!top || viewCount > (top.statistics?.viewCount||0)) top = v;
  });

  const issues = [];
  const videosCount = Math.max(1, videos.length);
  const avgViews = totals.views / videosCount;
  const avgLikes = totals.likes / videosCount;
  const avgComments = totals.comments / videosCount;

  const missingTags = videos.filter(v => !v.snippet.tags || v.snippet.tags.length===0).length;
  const shortDesc = videos.filter(v => (v.snippet.description||'').length < 50).length;
  const longTitles = videos.filter(v => (v.snippet.title||'').length > 80).length;
  
  if(missingTags > videos.length*0.3) issues.push({k:'Missing tags',desc:`${missingTags} of ${videos.length} videos have no tags. Tags help discovery and related video matching.`});
  if(shortDesc > videos.length*0.2) issues.push({k:'Short descriptions',desc:`${shortDesc} videos have very short descriptions. Use 200+ characters with keywords and links.`});
  if(longTitles>0) issues.push({k:'Long titles',desc:`${longTitles} videos have titles longer than 80 characters — shorter titles perform better on many devices.`});
  if(avgViews < 50) issues.push({k:'Low Average Views', desc: `Average video views are very low (${avgViews.toFixed(0)}). Focus on quality content and promotion.`});
  if(channel.snippet.country === undefined) issues.push({k:'Missing Channel Country', desc: `Channel country is not set. Set it for regional targeting.`});

  const dates = videos.map(v=> new Date(v.snippet.publishedAt));
  dates.sort((a,b)=>a-b);
  let avgUploadGap = 0;
  if(dates.length>=2){
    const diffs = [];
    for(let i=1;i<dates.length;i++) diffs.push( (dates[i]-dates[i-1]) / (1000*60*60*24) );
    avgUploadGap = diffs.reduce((a,b)=>a+b,0)/diffs.length;
    if(avgUploadGap>30) issues.push({k:'Low upload frequency',desc:`Average upload gap is ${avgUploadGap.toFixed(1)} days. More consistent uploads (weekly or biweekly) help channel growth.`});
  }

  return {totals, top, issues, avgViews, avgLikes, avgComments, missingTagsCount: missingTags, avgUploadGap};
}

function renderTopVideos(channel, videos){
    // Channel name/handle for the top of the video list (like your screenshot)
    document.getElementById('fullReport').querySelector('h2').previousElementSibling.innerHTML = `
        <strong>Channel: ${channel.snippet.title}</strong>
        <div class="muted">@${channel.snippet.customUrl || 'N/A'}</div>
        <div style="margin-top:8px">
            <span class="kpi">Subscribers: ${channel.statistics.subscriberCount||'—'}</span>
            <span class="kpi">Total views (channel): ${channel.statistics.viewCount||0}</span>
            <span class="kpi">Videos fetched: ${videos.length}</span>
        </div>
    `;

    // Top 10 videos (like your screenshot)
    const top = videos.slice().sort((a,b)=> (Number(b.statistics.viewCount||0) - Number(a.statistics.viewCount||0))).slice(0,10);
    let html = '<ol style="padding-left: 20px;">' + top.map(v=>{
        const tags = (v.snippet.tags || []).map(tag => `#${tag}`).join(' ');
        return `<li>
            <a target="_blank" href="https://youtu.be/${v.id}">${v.snippet.title}</a> 
            <span class="muted small">${tags}</span> — ${v.statistics.viewCount||0} views
        </li>`;
    }).join('') + '</ol>';
    topVideosEl.innerHTML = html;
}

function renderVideoTable(videos){
  const rows = videos.map(v=>{
    const s=v.statistics||{}; const snippet=v.snippet||{};
    return `<tr>
      <td><a target=_blank href="https://youtu.be/${v.id}">${escapeHtml(snippet.title||'')}</a></td>
      <td>${snippet.publishedAt? new Date(snippet.publishedAt).toLocaleDateString():''}</td>
      <td>${s.viewCount||0}</td>
      <td>${s.likeCount||'—'}</td>
      <td>${(snippet.tags && snippet.tags.length)?snippet.tags.length:0}</td>
      <td class="small">${escapeHtml( (snippet.description||'').slice(0,120) )}${(snippet.description||'').length>120?'...':''}</td>
    </tr>`;
  }).join('');
  videoTableEl.innerHTML = `<table><thead><tr><th>Title</th><th>Date</th><th>Views</th><th>Likes</th><th>Tags</th><th>Description (preview)</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function renderAudit(issues){
  if(issues.length===0) auditEl.innerHTML = '<div class="good">No major automated issues found. Manual review recommended for thumbnails and watch-time metrics.</div>';
  else{
    auditEl.innerHTML = '<ul>' + issues.map(it=>`<li><strong>${it.k}:</strong> ${it.desc}</li>`).join('') + '</ul>';
  }
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function videosToCsv(videos){
  const hdr = ['id','title','publishedAt','views','likes','comments','tags','description'];
  const rows = videos.map(v=>{
    const s=v.statistics||{}; const sn=v.snippet||{};
    const tags = (sn.tags||[]).join('|');
    return [v.id, `"${(sn.title||'').replace(/"/g,'""') }"`, sn.publishedAt||'', s.viewCount||0, s.likeCount||0, s.commentCount||0, `"${tags}"`, `"${(sn.description||'').replace(/"/g,'""')}"`].join(',');
  });
  return [hdr.join(','), ...rows].join('\n');
}

searchBtn.addEventListener('click', async ()=>{
  const q = queryEl.value.trim();
  if(!q){ alert('Please enter a channel name or ID'); return; }

  try{
    log('Fetching channel data securely...');
    
    // **SERVER CALL: SEO Audit tool ka endpoint using the new temporary URL**
    const res = await fetch(`${API_BASE_URL}/data?query=` + encodeURIComponent(q));
    
    if (!res.ok) {
        const errorText = await res.text();
        // Check if the error is 403 Forbidden
        if(res.status === 403) {
            throw new Error(`403 Forbidden: Google API is blocking access. Please ensure your API key has "Don't restrict key" selected in Google Cloud Console.`);
        }
        throw new Error(`Failed to fetch data: ${res.status} ${res.statusText} | Response: ${errorText}`);
    }
    
    const data = await res.json();

    if (data.error) {
        throw new Error(data.error);
    }
    
    const channel = data.channel;
    const videos = data.videos || []; 
    
    log(`Got ${videos.length} video details — Analyzing...`);
    const analysis = analyzeVideos(channel, videos);
    
    renderAuditGrid(channel, videos, analysis);
    renderTopVideos(channel, videos);
    renderVideoTable(videos);
    renderAudit(analysis.issues);
    
    downloadCsvBtn.disabled = false;
    downloadCsvBtn.onclick = ()=>{
      const csv = videosToCsv(videos);
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${channel.snippet.title.replace(/\W+/g,'_')}_videos.csv`; a.click();
    }
    log('Done. Review the audit and suggestions.');
  }catch(e){
    console.error(e); 
    log('Error: ' + e.message); 
    alert('Error: ' + e.message); // Alert user with the detailed error
  }
});

</script></body>
</html>
